rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) &&
          exists(/databases/$(database)/documents/userProfiles/$(userId));
    }

    function isChairperson() {
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == 'Chairperson';
    }

    function isCoordinator() {
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == 'Coordinator';
    }

    function isInvestmentLead() {
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == 'Investment Lead';
    }
    
    function isTreasurer() {
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == 'Treasurer';
    }

    function isSecretary() {
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == 'Secretary';
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    match /roles_admin/{userId} {
      allow get: if isSignedIn() && isAdmin();
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if false;
      allow delete: if false;
    }

    match /userProfiles/{userId} {
      allow get: if isSignedIn() &&
        (isOwner(userId) || isTreasurer() || isAdmin() || isChairperson());

      allow list: if isSignedIn() &&
        (isAdmin() || isTreasurer() || isChairperson());

      allow create: if isSignedIn() && isOwner(userId);

      allow update: if 
        (isAdmin() &&
          !request.resource.data.diff(resource.data)
            .affectedKeys()
            .hasAny(['treasurerApproved', 'chairpersonApproved'])) ||
        ((isTreasurer() || isChairperson()) &&
          request.resource.data.diff(resource.data)
            .affectedKeys()
            .hasAny(['treasurerApproved', 'chairpersonApproved', 'status', 'role'])) ||
        (isOwner(userId) &&
          request.resource.data.diff(resource.data)
            .affectedKeys()
            .hasOnly(['firstName', 'lastName', 'phone', 'photoURL']));

      allow delete: if 
        isAdmin() ||
        isExistingOwner(userId) ||
        ((isChairperson() || isTreasurer()) && resource.data.status == 'pending');
    }

    match /financialYears/{financialYearId} {
      allow get, list: if isSignedIn();
      allow create, update: if isSignedIn() &&
        (isChairperson() || isTreasurer());
      allow delete: if false;
    }

    // ✅ FIX: admin can read member contributions (shares)
    match /userProfiles/{userId}/contributions/{contributionId} {
      allow get, list: if isSignedIn() &&
        (isOwner(userId) || isTreasurer() || isChairperson() || isAdmin());

      allow create, update: if isSignedIn() &&
        (request.auth.uid == userId || isTreasurer());

      allow delete: if isExistingOwner(userId);
    }

    // ✅ FIX: admin collection-group shares query
    match /{path=**}/contributions/{contributionId} {
      allow get, list: if isSignedIn() &&
        (isInvestmentLead() || isChairperson() || isAdmin() || isTreasurer());
    }

    match /userProfiles/{userId}/specialContributions/{specialContributionId} {
      allow get, list: if isSignedIn() &&
        (isOwner(userId) || isTreasurer() || isChairperson());

      allow create, update, delete: if isSignedIn() && isTreasurer();
    }
    
    match /{path=**}/specialContributions/{specialContributionId} {
      allow list: if isSignedIn() &&
        (isTreasurer() || isInvestmentLead() || isChairperson() || isAdmin());
    }

    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn() && isCoordinator();
    }

    match /constitution/{constitutionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isChairperson();
    }

    match /investmentReports/{investmentReportId} {
      allow get, list: if isSignedIn();
      allow create, update: if isSignedIn() && isInvestmentLead();
      allow delete: if false;
    }

    match /investmentIdeas/{ideaId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() &&
        (isInvestmentLead() || isChairperson());
    }

    match /meetingMinutes/{minuteId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() &&
        (isSecretary() || isAdmin());
    }

    match /expenditures/{expenditureId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isTreasurer();
    }

    match /miscellaneousIncomes/{incomeId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() &&
        (isTreasurer() || isChairperson());
    }

    match /polls/{pollId} {
      allow get, list: if isSignedIn();

      allow create: if isSignedIn() &&
        request.auth.uid == request.resource.data.creatorId;

      allow update: if isSignedIn() &&
        (isOwner(resource.data.creatorId) || isChairperson() || isAdmin());

      allow delete: if isSignedIn() &&
        ((resource.data.creatorId != null &&
          resource.data.creatorId == request.auth.uid)
         || isChairperson()
         || isAdmin());

      allow update: if isSignedIn() &&
        request.resource.data.diff(resource.data)
          .changedKeys()
          .hasOnly(['options', 'voters']);
    }

    function hasVoted(pollId) {
      return exists(/databases/$(database)/documents/polls/$(pollId)/votes/$(request.auth.uid));
    }
    
    match /polls/{pollId}/votes/{voteId} {
      allow get: if isSignedIn();

      allow list: if isSignedIn() &&
        (hasVoted(pollId) || isChairperson() || isAdmin());

      allow create, update: if isSignedIn() &&
        voteId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid;
      
      allow delete: if isSignedIn() &&
        (isOwner(voteId)
         || isOwner(get(/databases/$(database)/documents/polls/$(pollId)).data.creatorId)
         || isChairperson()
         || isAdmin());
    }
  }
}
